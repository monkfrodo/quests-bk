<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Quest Teams | Blackout Guild</title>

<!-- Favicon Tibia (opcional) -->
<link rel="icon" href="https://static.tibia.com/images/global/general/favicon.ico?v=3" type="image/x-icon">
<link rel="shortcut icon" href="https://static.tibia.com/images/global/general/favicon.ico?v=3" type="image/x-icon">
<link rel="apple-touch-icon" href="https://static.tibia.com/images/global/general/favicon.ico?v=3">

<style>
  :root{
    --bg:#0b1220;
    --card:#0a0f19d9;  /* translúcido */
    --border:rgba(255,255,255,.08);
    --accent:#3b82f6; /* azul Lightbearer */
    --muted:#8fa1c2;
    --green:#22c55e;
    --orange:#f59e0b;
    --red:#ef4444;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; color:#e5ecff;
    font-family:Inter,system-ui,sans-serif;
    background: var(--bg) url('https://static.tibia.com/images/news/lightbearer_280.png') no-repeat center top / cover fixed;
    position:relative;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:0;
    background:linear-gradient(rgba(0,0,0,.65), rgba(0,0,0,.8));
    pointer-events:none;
  }
  .wrap{position:relative; z-index:1; max-width:1100px; margin:0 auto; padding:60px 16px 40px}
  header{
    display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:16px;
  }
  header img{width:40px; height:auto; opacity:.9}
  h1{margin:0; font-size:28px; font-weight:800; text-align:center}
  .subtitle{ text-align:center; color:var(--muted); font-size:15px; margin-bottom:26px }

  /* Card do formulário */
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:24px;
    box-shadow:0 4px 25px rgba(0,0,0,.3);
    margin-bottom:28px;
  }
  .form-grid{
    display:grid; gap:14px;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    align-items:end;
  }
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
  input, select{
    width:100%; padding:12px 14px;
    border-radius:10px; border:1px solid var(--border);
    background:#10182b; color:#e5ecff; font-size:15px;
  }
  .btn{
    padding:14px 22px; border:none; border-radius:12px; font-weight:700;
    background:var(--accent); color:#fff; cursor:pointer; transition:.2s;
  }
  .btn:hover{opacity:.9; transform:translateY(-1px)}

  /* Autocomplete */
  .autocomplete{ position:relative }
  .autocomplete-list{
    position:absolute; top:100%; left:0; right:0; z-index:20;
    background:#10182b; border:1px solid rgba(255,255,255,.15);
    border-radius:10px; margin-top:6px; max-height:220px; overflow:auto; display:none;
  }
  .autocomplete-item{ padding:10px 12px; cursor:pointer; font-size:14px }
  .autocomplete-item:hover{ background:rgba(255,255,255,.1) }

  /* Lista de Quests */
  .legend{
    color:var(--muted); font-size:13px; margin:12px 0 8px; text-align:center;
  }
  .legend .dot{display:inline-block; width:10px; height:10px; border-radius:50%; margin:0 6px -1px 10px}
  .quests{
    display:grid; gap:16px;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  }
  .quest{
    background:rgba(255,255,255,.05);
    border:1px solid var(--border);
    border-radius:16px; padding:16px;
    transition:.25s; cursor:pointer;
  }
  .quest:hover{ background:rgba(255,255,255,.08); transform:translateY(-2px) }
  .q-head{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .q-title{font-weight:800}
  .badge{
    font-size:11px; font-weight:800; padding:4px 10px; border-radius:999px;
  }
  .badge.red{ background:rgba(239,68,68,.15); color:var(--red) }
  .badge.orange{ background:rgba(245,158,11,.15); color:var(--orange) }
  .badge.green{ background:rgba(34,197,94,.15); color:var(--green) }

  .bar{margin-top:10px; height:8px; background:#0b1220; border-radius:999px; overflow:hidden}
  .fill{height:100%; width:0%; background:var(--green); transition:width .5s}

  .players{ display:none; margin-top:10px; border-top:1px solid var(--border); padding-top:10px }
  .player{ font-size:14px; color:#cfe2ff; margin:4px 0 }
  .muted{ color:var(--muted); font-size:13px; }

  .footer{margin-top:34px; text-align:center; color:var(--muted); font-size:13px; border-top:1px solid rgba(255,255,255,.1); padding-top:18px}
  .footer .icon{ display:flex; justify-content:center; margin-top:18px }
  .footer .icon img{ width:120px; opacity:.8 }
  @media (min-width:900px){ .footer .icon img{ width:160px } }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="https://static.tibia.com/images/news/lightbearer_280.png" alt="Lightbearer">
    <h1>Quest Teams | Blackout Guild</h1>
  </header>
  <div class="subtitle">Monte times para quests. Digite o nome da quest e veja quem já está dentro.</div>

  <!-- Formulário -->
  <div class="card">
    <form id="form">
      <div class="form-grid">
        <div>
          <label for="nome">Nome</label>
          <input id="nome" placeholder="Seu nome" required>
        </div>
        <div>
          <label for="vocacao">Vocação</label>
          <select id="vocacao" required>
            <option value="">Selecione</option>
            <option>EK</option>
            <option>RP</option>
            <option>MS</option>
            <option>ED</option>
            <option>EM</option>
          </select>
        </div>
        <div>
          <label for="level">Level</label>
          <input id="level" type="number" min="1" step="1" placeholder="Ex: 250" required>
        </div>
        <div class="autocomplete">
          <label for="quest">Quest</label>
          <input id="quest" placeholder="Digite a quest..." autocomplete="off" required>
          <div id="acList" class="autocomplete-list"></div>
        </div>
      </div>
      <div style="margin-top:14px; display:flex; justify-content:center">
        <button class="btn" type="submit">Registrar interesse</button>
      </div>
    </form>
    <div id="status" class="muted" style="text-align:center; margin-top:8px"></div>
  </div>

  <!-- Legenda + Lista -->
  <div class="legend">
    <span class="dot" style="background:var(--red)"></span>2 jogadores
    <span class="dot" style="background:var(--orange)"></span>3–4 jogadores
    <span class="dot" style="background:var(--green)"></span>5+ jogadores
  </div>

  <div id="quests" class="quests"></div>

  <div class="footer">
    <strong>Blackout Guild | Todos os direitos reservados.</strong>
    <div class="icon">
      <img src="https://static.tibia.com/images/news/lightbearer_280.png" alt="Lightbearer Icon">
    </div>
  </div>
</div>

<script>
  /* ================== CONFIG ================== */
  const API = "https://script.google.com/macros/s/AKfycbziIHrXBpoNWvDiclUBfNu-YrxfGVJMZ70LOrxWzKlDHAOQxhbYsEtwpT-YoSEBRbss1w/exec"; // <--- substitua pelo seu Web App (GET/POST)

  /* ============== Estado & Utilitários ============== */
  let allQuestNames = [];      // para autocomplete
  let lastData = [];           // cache para evitar re-render desnecessário

  const $ = sel => document.querySelector(sel);
  const acList = $('#acList');
  const statusEl = $('#status');

  function teamBadge(count){
    if (count <= 1) return {cls:'red',    label:`${count} jogador`};
    if (count === 2) return {cls:'red',    label:`${count} jogadores`};
    if (count <= 4)  return {cls:'orange', label:`${count} jogadores`};
    return {cls:'green', label:`${count} jogadores`};
  }
  function barWidth(count){
    // simbólico rumo a 5 (time “ideal”)
    const pct = Math.min((count/5)*100, 100);
    return pct.toFixed(0) + '%';
  }

  /* ============== Autocomplete dinâmico ============== */
  function showAutocomplete(term){
    acList.innerHTML = '';
    term = (term||'').trim().toLowerCase();
    if (!term){ acList.style.display='none'; return; }
    const filtered = allQuestNames
      .filter(q => q.toLowerCase().includes(term))
      .slice(0, 12);
    if (filtered.length === 0){ acList.style.display='none'; return; }

    filtered.forEach(q=>{
      const div = document.createElement('div');
      div.className = 'autocomplete-item';
      div.textContent = q;
      div.onclick = () => {
        $('#quest').value = q;
        acList.style.display = 'none';
      };
      acList.appendChild(div);
    });
    acList.style.display='block';
  }
  $('#quest').addEventListener('input', e => showAutocomplete(e.target.value));
  document.addEventListener('click', e=>{
    if(!e.target.closest('.autocomplete')) acList.style.display='none';
  });

  /* ============== Renderização ============== */
  function render(data){
    // evita piscar se nada mudou
    const serializedNew = JSON.stringify(data);
    const serializedOld = JSON.stringify(lastData);
    if (serializedNew === serializedOld) return;
    lastData = data;

    // lista de nomes para autocomplete
    allQuestNames = data.map(q => q.quest).filter(Boolean);

    const wrap = $('#quests');
    wrap.innerHTML = '';

    if (!data.length){
      wrap.innerHTML = `<div class="muted" style="grid-column:1/-1;text-align:center">Nenhuma quest registrada ainda.</div>`;
      return;
    }

    data.forEach(q=>{
      const badge = teamBadge(q.count);
      const card = document.createElement('div');
      card.className = 'quest';
      card.innerHTML = `
        <div class="q-head">
          <div class="q-title">${q.quest}</div>
          <div class="badge ${badge.cls}">${badge.label}</div>
        </div>
        <div class="bar" aria-hidden="true">
          <div class="fill" style="width:${barWidth(q.count)}"></div>
        </div>
        <div class="players">
          ${Array.isArray(q.players) && q.players.length ? q.players.map(p=>(
            `<div class="player">• <b>${(p.nome||'Sem nome')}</b> (${p.vocacao||'—'}, lvl ${p.level||'—'})</div>`
          )).join('') : `<div class="muted">Ainda sem jogadores listados.</div>`}
        </div>
      `;
      // toggle participantes
      card.addEventListener('click', e=>{
        if (e.target.closest('button, input, select, a')) return; // ignora cliques em inputs
        const pl = card.querySelector('.players');
        pl.style.display = (pl.style.display==='block'?'none':'block');
      });
      wrap.appendChild(card);
    });
  }

  /* ============== Carregar dados do backend ============== */
  async function fetchQuests(){
    try{
      statusEl.textContent = 'Carregando times...';
      const res = await fetch(API, { method:'GET' });
      // Se seu Apps Script retorna JSON puro (ContentService JSON), isso funciona:
      const data = await res.json();
      // Esperado: [{ quest, count, players:[{nome,vocacao,level,data}] }, ...]
      render(Array.isArray(data) ? data : []);
      statusEl.textContent = '';
    }catch(err){
      statusEl.textContent = 'Não foi possível carregar os times agora.';
      console.error(err);
    }
  }

  /* ============== Registrar interesse ============== */
  $('#form').addEventListener('submit', async e=>{
    e.preventDefault();
    const nome  = $('#nome').value.trim();
    const voc   = $('#vocacao').value.trim();
    const lvl   = $('#level').value.trim();
    const quest = $('#quest').value.trim();
    if (!nome || !voc || !lvl || !quest) return;

    try{
      statusEl.textContent = 'Enviando...';
      const fd = new FormData();
      fd.append('nome', nome);
      fd.append('vocacao', voc);
      fd.append('level', lvl);
      fd.append('quest', quest);

      // Muitos Apps Script funcionam melhor com no-cors no POST público
      await fetch(API, { method:'POST', body:fd, mode:'no-cors' });

      // Reseta e recarrega
      $('#form').reset();
      acList.style.display='none';
      statusEl.textContent = 'Registrado!';
      // pequeno atraso para garantir que a planilha gravou
      setTimeout(fetchQuests, 1200);
    }catch(err){
      statusEl.textContent = 'Falha ao registrar.';
      console.error(err);
    }
  });

  // Inicialização
  fetchQuests();
  // Atualização automática a cada 30s
  setInterval(fetchQuests, 30000);
</script>
</body>
</html>
